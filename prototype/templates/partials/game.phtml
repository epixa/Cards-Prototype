
<h1>Playing: <?php echo htmlentities($game->name); ?></h1>
<div>Total players: <span id="total-players"><?php echo (int)$totalPlayers; ?></span></div>
<a id="stop-game" href="#stop-game">Stop Game</a>

<section id="table"></section>
<ul id="players">
    <li class="player" id="player-base"></li>
</ul>


<script type="text/javascript">
(function(){
    var players = $('#players');
    var basePlayer = $('#player-base').clone();
    $('#player-base').remove();

    $('#stop-game').click(function(e){
        e.preventDefault();

        if (confirm("Are you sure you want to stop the current game?")) {
            $.post('/ajax.php?action=stop-game', function(data){
                if (data.status == 'error') {
                    $(document).trigger('ajax.error', [data]);
                } else if (data.status == 'success') {
                    window.location.href = '/';
                }
            }, 'json');
        }
    });

    var originalCallback = room.loadGameDataCallback;
    room.loadGameDataCallback = function(data){
        if (!data.game) {
            alert('Someone has stopped the current game');
            window.location.href = '/';
        } else {
            for (var x in data.game.players) {
                var player = data.game.players[x];

                if (!room.hasPlayer(player.id)) {
                    var container = basePlayer.clone();
                    players.append(container);
                    room.addPlayer(player, container);
                } else {
                    room.getPlayer(player.id).populate(player);
                }
            }

            for (var id in room.players) {
                if (!(id in data.game.players)) {
                    room.removePlayer(id);
                }
            }

            $('#total-players').html(data.game.totalPlayers);
            
            originalCallback(data);
        }
    };
    room.beginPolling();
})();
</script>